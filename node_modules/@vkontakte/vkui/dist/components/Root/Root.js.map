{"version":3,"sources":["../../../src/components/Root/Root.tsx"],"names":["React","classNames","getClassName","animationEvent","ANDROID","VKCOM","withPlatform","withContext","ConfigProviderContext","SplitColContext","AppRootPortal","canUseDOM","withDOM","ScrollContext","getNavId","warnOnce","warn","Root","props","e","includes","animationName","isBack","state","prevView","nextView","setState","activeView","visibleViews","transition","undefined","scroll","scrollTo","scrolls","onTransition","from","to","document","prevProps","prevState","popout","blurActiveElement","pageYOffset","getScroll","y","firstLayerId","concat","children","map","view","find","id","prevViewElement","viewNodes","nextViewElement","setPanelScroll","pan","querySelector","scrollTop","waitAnimationFinish","onAnimationEnd","configProvider","transitionMotionEnabled","splitCol","animate","elem","eventHandler","shouldDisableTransitionMotion","supported","removeEventListener","name","addEventListener","clearTimeout","animationFinishTimeout","setTimeout","bind","platform","activeElement","blur","modal","_1","window","nav","restProps","Views","Children","toArray","filter","baseClassName","disableAnimation","viewId","Component"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { classNames } from '../../lib/classNames';\nimport { getClassName } from '../../helpers/getClassName';\nimport { animationEvent } from '../../lib/supportEvents';\nimport { ANDROID, VKCOM } from '../../lib/platform';\nimport { withPlatform } from '../../hoc/withPlatform';\nimport { withContext } from '../../hoc/withContext';\nimport { HasPlatform } from '../../types';\nimport { ConfigProviderContext, ConfigProviderContextInterface } from '../ConfigProvider/ConfigProviderContext';\nimport { SplitColContextProps, SplitColContext } from '../SplitCol/SplitCol';\nimport { AppRootPortal } from '../AppRoot/AppRootPortal';\nimport { canUseDOM, DOMProps, withDOM } from '../../lib/dom';\nimport { ScrollContext, ScrollContextInterface } from '../AppRoot/ScrollContext';\nimport { getNavId, NavIdProps } from '../../lib/getNavId';\nimport { warnOnce } from '../../lib/warnOnce';\nimport './Root.css';\n\nconst warn = warnOnce('Root');\n\nexport interface RootProps extends React.HTMLAttributes<HTMLDivElement>, HasPlatform, NavIdProps {\n  activeView: string;\n  onTransition?(params: { isBack: boolean; from: string; to: string }): void;\n  /**\n   * @deprecated будет удалено в 5.0.0. Используйте одноименное свойство у `SplitLayout`.\n   *\n   * Свойство для отрисовки `Alert`, `ActionSheet` и `ScreenSpinner`.\n   */\n  popout?: React.ReactNode;\n  /**\n   * @deprecated будет удалено в 5.0.0. Используйте одноименное свойство у `SplitLayout`.\n   *\n   * Свойство для отрисовки `ModalRoot`.\n   */\n  modal?: React.ReactNode;\n  /**\n   * @ignore\n   */\n  splitCol?: SplitColContextProps;\n  /**\n   * @ignore\n   */\n  configProvider?: ConfigProviderContextInterface;\n  /**\n   * @ignore\n   */\n  scroll?: ScrollContextInterface;\n}\n\nexport type AnimationEndCallback = (e?: AnimationEvent) => void;\n\nexport interface RootState {\n  activeView: string;\n  prevView: string;\n  nextView: string;\n  visibleViews: [string] | [string, string];\n  isBack: boolean;\n  scrolls: {\n    [index: string]: number;\n  };\n  transition: boolean;\n}\n\nclass Root extends React.Component<RootProps & DOMProps, RootState> {\n  constructor(props: RootProps) {\n    super(props);\n\n    this.state = {\n      activeView: props.activeView,\n      prevView: null,\n      nextView: null,\n      visibleViews: [props.activeView],\n      isBack: undefined,\n      scrolls: {},\n      transition: false,\n    };\n  }\n\n  static defaultProps: Partial<RootProps> = {\n    popout: null,\n  };\n\n  private animationFinishTimeout: ReturnType<typeof setTimeout>;\n  private viewNodes: { [id: string]: HTMLElement } = {};\n\n  get document() {\n    return this.props.document;\n  }\n\n  componentDidUpdate(prevProps: RootProps, prevState: RootState) {\n    if (this.props.popout && !prevProps.popout) {\n      this.blurActiveElement();\n    }\n\n    // Нужен переход\n    if (this.props.activeView !== prevProps.activeView) {\n      let pageYOffset = this.props.scroll.getScroll().y;\n      const firstLayerId = [].concat(prevProps.children)\n        .map((view) => getNavId(view.props, warn))\n        .find((id) => id === prevProps.activeView || id === this.props.activeView);\n      const isBack = firstLayerId === this.props.activeView;\n\n      this.blurActiveElement();\n\n      const nextView = this.props.activeView;\n      const prevView = prevProps.activeView;\n\n      this.setState({\n        scrolls: {\n          ...this.state.scrolls,\n          [prevProps.activeView]: pageYOffset,\n        },\n        transition: true,\n        activeView: null,\n        nextView,\n        prevView,\n        visibleViews: [nextView, prevView],\n        isBack,\n      });\n    }\n\n    // Начался переход\n    if (!prevState.transition && this.state.transition) {\n      const prevViewElement = this.viewNodes[this.state.prevView];\n      const nextViewElement = this.viewNodes[this.state.nextView];\n      const setPanelScroll = (e: HTMLElement, scroll: number) => {\n        // eslint-disable-next-line no-restricted-properties\n        const pan: HTMLElement | null = e.querySelector('[data-vkui-active-panel=true]');\n        pan && (pan.scrollTop = scroll);\n      };\n\n      setPanelScroll(prevViewElement, this.state.scrolls[this.state.prevView]);\n\n      if (this.state.isBack) {\n        setPanelScroll(nextViewElement, this.state.scrolls[this.state.nextView]);\n      }\n      this.waitAnimationFinish(this.state.isBack ? prevViewElement : nextViewElement, this.onAnimationEnd);\n    }\n  }\n\n  shouldDisableTransitionMotion(): boolean {\n    return this.props.configProvider.transitionMotionEnabled === false ||\n      !this.props.splitCol.animate;\n  }\n\n  waitAnimationFinish(elem: HTMLElement, eventHandler: AnimationEndCallback) {\n    if (this.shouldDisableTransitionMotion()) {\n      eventHandler();\n      return;\n    }\n\n    if (animationEvent.supported) {\n      elem.removeEventListener(animationEvent.name, eventHandler);\n      elem.addEventListener(animationEvent.name, eventHandler);\n    } else {\n      clearTimeout(this.animationFinishTimeout);\n      this.animationFinishTimeout = setTimeout(eventHandler.bind(this), this.props.platform === ANDROID || this.props.platform === VKCOM ? 300 : 600);\n    }\n  }\n\n  onAnimationEnd: AnimationEndCallback = (e?: AnimationEvent) => {\n    if (!e || [\n      'vkui-root-android-animation-hide-back',\n      'vkui-root-android-animation-show-forward',\n      'vkui-root-ios-animation-hide-back',\n      'vkui-root-ios-animation-show-forward',\n    ].includes(e.animationName)) {\n      const isBack = this.state.isBack;\n      const prevView = this.state.prevView;\n      const nextView = this.state.nextView;\n      this.setState({\n        activeView: nextView,\n        prevView: null,\n        nextView: null,\n        visibleViews: [nextView],\n        transition: false,\n        isBack: undefined,\n      }, () => {\n        this.props.scroll.scrollTo(0, isBack ? this.state.scrolls[this.state.activeView] : 0);\n        this.props.onTransition && this.props.onTransition({ isBack, from: prevView, to: nextView });\n      });\n    }\n  };\n\n  blurActiveElement() {\n    if (canUseDOM && this.document.activeElement) {\n      (this.document.activeElement as HTMLElement).blur();\n    }\n  }\n\n  render() {\n    const {\n      popout, modal, platform,\n      splitCol, configProvider, activeView: _1, onTransition,\n      window, document, scroll, nav,\n      ...restProps\n    } = this.props;\n    const { transition, isBack, prevView, activeView, nextView } = this.state;\n\n    const Views = React.Children.toArray(this.props.children).filter((view: React.ReactElement) => {\n      return this.state.visibleViews.includes(getNavId(view.props, warn));\n    });\n\n    const baseClassName = getClassName('Root', platform);\n    const disableAnimation = this.shouldDisableTransitionMotion();\n\n    return (\n      <div {...restProps} vkuiClass={classNames(baseClassName, {\n        'Root--transition': !disableAnimation && transition,\n        'Root--no-motion': disableAnimation,\n      })}>\n        {Views.map((view: React.ReactElement) => {\n          const viewId = getNavId(view.props, warn);\n          return (\n            <div key={viewId} ref={(e) => this.viewNodes[viewId] = e} vkuiClass={classNames('Root__view', {\n              'Root__view--hide-back': viewId === prevView && isBack,\n              'Root__view--hide-forward': viewId === prevView && !isBack,\n              'Root__view--show-back': viewId === nextView && isBack,\n              'Root__view--show-forward': viewId === nextView && !isBack,\n              'Root__view--active': viewId === activeView,\n            })}>\n              {view}\n            </div>\n          );\n        })}\n        <AppRootPortal>\n          {!!popout && <div vkuiClass=\"Root__popout\">{popout}</div>}\n          {!!modal && <div vkuiClass=\"Root__modal\">{modal}</div>}\n        </AppRootPortal>\n      </div>\n    );\n  }\n}\n\nexport default withContext(withContext(withContext(\n  withPlatform(withDOM<RootProps>(Root)),\n  SplitColContext,\n  'splitCol',\n), ConfigProviderContext, 'configProvider'), ScrollContext, 'scroll');\n"],"file":"Root.js"}