{"version":3,"sources":["../../../../src/components/ModalRoot/ModalRoot.tsx"],"names":["warn","IS_DEV","process","env","NODE_ENV","numberInRange","number","range","rangeTranslate","Math","max","min","ModalRootTouchComponent","props","React","createRef","event","originalEvent","preventDefault","activeModal","state","nextModal","modalState","modalsState","animateTranslate","translateY","modalId","undefined","type","ModalType","PAGE","dynamicContentHeight","switching","waitTransitionFinish","requestAnimationFrame","checkPageContentHeight","e","onPageTouchMove","CARD","onCardTouchMove","onPageTouchEnd","onCardTouchEnd","target","contentElement","contains","contentScrolled","clearTimeout","contentScrollStopTimeout","setTimeout","activeTransitions","newState","prevModal","visibleModals","animated","history","setState","activeModalState","doCloseModal","touchDown","onClose","id","isBack","inited","dragging","maskElementRef","initModalsState","modalRootContext","updateModalHeight","registerModal","data","Object","assign","triggerActiveModalClose","isInsideModal","frameIds","document","window","Children","toArray","children","getModals","reduce","acc","Modal","modalProps","settlingHeight","initActiveModal","toggleDocumentScrolling","platform","IOS","removeEventListener","updateModalTranslate","prevProps","prevState","includes","splice","indexOf","push","closeActiveModal","switchPrevNext","enabled","documentScrolling","preventTouch","passive","addEventListener","MODAL_PAGE_DEFAULT_PERCENT_HEIGHT","initPageModal","initCardModal","contentHeight","firstElementChild","offsetHeight","prevTranslateY","expandable","clientHeight","collapsed","expanded","translateYFrom","expandedRange","collapsedRange","hiddenRange","shiftHalf","visiblePart","headerHeight","headerElement","height","innerElement","parentElement","modalElement","prevModalState","currentModalState","needAnimate","prevNextSwitchEndHandler","setMaskOpacity","shiftY","startT","isY","viewportRef","current","stopPropagation","touchStartTime","touchStartContentScrollTop","scrollTop","touchMovePositive","shiftYPercent","innerHeight","shiftYCurrent","ANDROID","VKCOM","touchShiftYPercent","translateYCurrent","startY","setStateCallback","shiftYEndPercent","expectTranslateY","Date","now","getTime","hidden","eventHandler","transitionEvent","supported","onceHandler","name","nextModalState","prevIsPage","prevIsCard","nextIsPage","nextIsCard","percent","frameId","cancelAnimationFrame","footerElement","footerHeight","factor","forceOpacity","maskAnimationFrame","opacity","style","toString","configProvider","webviewType","WebviewType","VKAPPS","onTouchMove","onTouchEnd","onScroll","map","isPage","key","Component","ModalRootTouch","ConfigProviderContext"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport Touch, { TouchEvent } from '../Touch/Touch';\nimport TouchRootContext from '../Touch/TouchContext';\nimport { getClassName } from '../../helpers/getClassName';\nimport { classNames } from '../../lib/classNames';\nimport { setTransformStyle } from '../../lib/styles';\nimport { rubber } from '../../lib/touch';\nimport { isFunction } from '../../lib/utils';\nimport { ANDROID, IOS, VKCOM } from '../../lib/platform';\nimport { transitionEvent } from '../../lib/supportEvents';\nimport { HasPlatform } from '../../types';\nimport { withPlatform } from '../../hoc/withPlatform';\nimport { withContext } from '../../hoc/withContext';\nimport ModalRootContext, { ModalRootContextInterface } from './ModalRootContext';\nimport {\n  ConfigProviderContext,\n  ConfigProviderContextInterface,\n  WebviewType,\n} from '../ConfigProvider/ConfigProviderContext';\nimport { ModalsState, ModalsStateEntry, ModalType, TranslateRange } from './types';\nimport { MODAL_PAGE_DEFAULT_PERCENT_HEIGHT } from './constants';\nimport { DOMProps, withDOM } from '../../lib/dom';\nimport { getNavId } from '../../lib/getNavId';\nimport { warnOnce } from '../../lib/warnOnce';\nimport './ModalRoot.css';\n\nconst warn = warnOnce('ModalRoot');\nconst IS_DEV = process.env.NODE_ENV === 'development';\n\nfunction numberInRange(number: number, range: TranslateRange) {\n  return number >= range[0] && number <= range[1];\n}\n\nfunction rangeTranslate(number: number) {\n  return Math.max(0, Math.min(98, number));\n}\n\nexport interface ModalRootProps extends HasPlatform {\n  activeModal?: string | null;\n\n  /**\n   * Будет вызвано при закрытии активной модалки с её id\n   */\n  onClose?(modalId: string): void;\n  /**\n   * @ignore\n   */\n  configProvider?: ConfigProviderContextInterface;\n}\n\ninterface ModalRootState {\n  activeModal?: string;\n  prevModal?: string;\n  nextModal?: string;\n  visibleModals?: string[];\n  animated?: boolean;\n  switching?: boolean;\n  history?: string[];\n  isBack?: boolean;\n  inited?: boolean;\n  touchDown?: boolean;\n  dragging?: boolean;\n}\n\nclass ModalRootTouchComponent extends React.Component<ModalRootProps & DOMProps, ModalRootState> {\n  constructor(props: ModalRootProps) {\n    super(props);\n\n    const activeModal = props.activeModal;\n\n    this.state = {\n      activeModal: null,\n      prevModal: null,\n      nextModal: activeModal,\n      visibleModals: activeModal ? [activeModal] : [],\n      animated: !!activeModal,\n      switching: false,\n      history: activeModal ? [activeModal] : [],\n      isBack: false,\n      inited: false,\n      touchDown: false,\n      dragging: false,\n    };\n\n    this.activeTransitions = 0;\n    this.maskElementRef = React.createRef();\n\n    this.initModalsState();\n\n    this.modalRootContext = {\n      updateModalHeight: this.updateModalHeight,\n      registerModal: ({ id, ...data }) => Object.assign(this.modalsState[id], data),\n      onClose: this.triggerActiveModalClose,\n      isInsideModal: true,\n    };\n\n    this.frameIds = {};\n  }\n\n  private modalsState: ModalsState;\n  private documentScrolling: boolean;\n  private activeTransitions: number;\n  private readonly maskElementRef: React.RefObject<HTMLDivElement>;\n  private readonly viewportRef = React.createRef<HTMLDivElement>();\n  private maskAnimationFrame: number;\n  private readonly modalRootContext: ModalRootContextInterface;\n  private readonly frameIds: {\n    [index: string]: number;\n  };\n\n  get document(): Document {\n    return this.props.document;\n  }\n\n  get window(): Window {\n    return this.props.window;\n  }\n\n  getModals() {\n    return React.Children.toArray(this.props.children) as React.ReactElement[];\n  }\n\n  initModalsState() {\n    this.modalsState = this.getModals().reduce<ModalsState>((acc, Modal) => {\n      const modalProps = Modal.props;\n      const state: ModalsStateEntry = {\n        id: getNavId(modalProps, warn),\n        onClose: Modal.props.onClose,\n        dynamicContentHeight: !!modalProps.dynamicContentHeight,\n      };\n\n      // ModalPage props\n      if (typeof modalProps.settlingHeight === 'number') {\n        state.settlingHeight = modalProps.settlingHeight;\n      }\n\n      acc[state.id] = state;\n      return acc;\n    }, {});\n  }\n\n  componentDidMount() {\n    this.initActiveModal();\n  }\n\n  componentWillUnmount() {\n    this.toggleDocumentScrolling(true);\n    if (this.props.platform === IOS) {\n      this.window.removeEventListener('resize', this.updateModalTranslate, false);\n    }\n  }\n\n  componentDidUpdate(prevProps: ModalRootProps, prevState: ModalRootState) {\n    if (this.props.activeModal !== prevProps.activeModal && !this.state.switching) {\n      const nextModal = this.props.activeModal;\n      const prevModal = prevProps.activeModal;\n\n      if (IS_DEV && nextModal !== null && !this.modalsState[nextModal]) {\n        return warn(`[componentDidUpdate] nextModal ${nextModal} not found`);\n      }\n\n      let history = [...this.state.history];\n      let isBack = false;\n\n      if (nextModal === null) {\n        history = [];\n      } else if (history.includes(nextModal)) {\n        history = history.splice(0, history.indexOf(nextModal) + 1);\n        isBack = true;\n      } else {\n        history.push(nextModal);\n      }\n\n      return this.setState({\n        activeModal: null,\n        nextModal,\n        prevModal,\n        visibleModals: [nextModal, prevModal],\n        history,\n        isBack,\n        animated: true,\n        inited: false,\n        switching: false,\n      }, () => {\n        if (nextModal === null) {\n          this.closeActiveModal();\n        } else {\n          this.initActiveModal();\n        }\n      });\n    }\n\n    if (this.state.switching && !prevState.switching) {\n      requestAnimationFrame(() => this.switchPrevNext());\n    }\n\n    if (!this.state.activeModal && !this.state.prevModal && !this.state.nextModal) {\n      this.toggleDocumentScrolling(true);\n    } else {\n      this.toggleDocumentScrolling(false);\n    }\n  }\n\n  /* Отключает скролл документа */\n  toggleDocumentScrolling(enabled: boolean) {\n    if (this.documentScrolling === enabled) {\n      return;\n    }\n    this.documentScrolling = enabled;\n\n    if (enabled) {\n      // Здесь нужен последний аргумент с такими же параметрами, потому что\n      // некоторые браузеры на странных вендорах типа Meizu не удаляют обработчик.\n      // https://github.com/VKCOM/VKUI/issues/444\n      // @ts-ignore (В интерфейсе EventListenerOptions нет поля passive)\n      this.window.removeEventListener('touchmove', this.preventTouch, { passive: false });\n    } else {\n      this.window.addEventListener('touchmove', this.preventTouch, { passive: false });\n    }\n  }\n\n  preventTouch = (event: any) => {\n    if (!event) {\n      return false;\n    }\n    while (event.originalEvent) {\n      event = event.originalEvent;\n    }\n    if (event.preventDefault) {\n      event.preventDefault();\n    }\n    return false;\n  };\n\n  /**\n   * Инициализирует модалку перед анимацией открытия\n   */\n  initActiveModal() {\n    const activeModal = this.state.activeModal || this.state.nextModal;\n    if (!activeModal) {\n      return;\n    }\n\n    const modalState = this.modalsState[activeModal];\n    // Отслеживаем изменение размеров viewport (Необходимо для iOS)\n    if (this.props.platform === IOS) {\n      this.window.addEventListener('resize', this.updateModalTranslate, false);\n    }\n\n    switch (modalState.type) {\n      case ModalType.PAGE:\n        modalState.settlingHeight = modalState.settlingHeight || MODAL_PAGE_DEFAULT_PERCENT_HEIGHT;\n        this.initPageModal(modalState);\n        break;\n\n      case ModalType.CARD:\n        this.initCardModal(modalState);\n        break;\n\n      default:\n        if (IS_DEV) {\n          warn('[initActiveModal] modalState.type is unknown');\n        }\n    }\n\n    this.setState({ inited: true, switching: true });\n  }\n\n  updateModalTranslate = () => {\n    const activeModal = this.state.activeModal || this.state.nextModal;\n    if (!activeModal) {\n      return;\n    }\n\n    const modalState = this.modalsState[activeModal];\n    this.animateTranslate(modalState, modalState.translateY);\n  };\n\n  initPageModal(modalState: ModalsStateEntry) {\n    const { contentElement } = modalState;\n    const contentHeight = (contentElement.firstElementChild as HTMLElement).offsetHeight;\n\n    let prevTranslateY = modalState.translateY;\n\n    modalState.expandable = contentHeight > contentElement.clientHeight || modalState.settlingHeight === 100;\n\n    let collapsed = false;\n    let expanded = false;\n    let translateYFrom;\n    let translateY;\n    let expandedRange: TranslateRange;\n    let collapsedRange: TranslateRange;\n    let hiddenRange: TranslateRange;\n\n    if (modalState.expandable) {\n      translateYFrom = 100 - modalState.settlingHeight;\n\n      const shiftHalf = translateYFrom / 2;\n      const visiblePart = 100 - translateYFrom;\n\n      expandedRange = [0, shiftHalf];\n      collapsedRange = [shiftHalf, translateYFrom + visiblePart / 4];\n      hiddenRange = [translateYFrom + visiblePart / 4, 100];\n\n      collapsed = translateYFrom > 0;\n      expanded = translateYFrom <= 0;\n      translateY = translateYFrom;\n    } else {\n      const headerHeight = modalState.headerElement.offsetHeight;\n      const height = contentHeight + headerHeight;\n\n      translateYFrom = 100 - height / modalState.innerElement.parentElement.offsetHeight * 100;\n      translateY = translateYFrom;\n\n      expandedRange = [translateY, translateY + 25];\n      collapsedRange = [translateY + 25, translateY + 25];\n      hiddenRange = [translateY + 25, translateY + 100];\n    }\n\n    // Если модалка может открываться на весь экран, и новый сдвиг больше предыдущего, то откроем её на весь экран\n    if (modalState.expandable && translateY > prevTranslateY || modalState.settlingHeight === 100) {\n      translateY = 0;\n    }\n\n    modalState.expandedRange = expandedRange;\n    modalState.collapsedRange = collapsedRange;\n    modalState.hiddenRange = hiddenRange;\n    modalState.translateY = translateY;\n    modalState.translateYFrom = translateYFrom;\n    modalState.collapsed = collapsed;\n    modalState.expanded = expanded;\n  }\n\n  initCardModal(modalState: ModalsStateEntry) {\n    modalState.translateY = 0;\n  }\n\n  checkPageContentHeight() {\n    const { activeModal, nextModal } = this.state;\n    const modalId = activeModal || nextModal;\n\n    const modalState = this.modalsState[modalId];\n    if (modalState?.type === ModalType.PAGE && modalState?.modalElement) {\n      const prevModalState = { ...modalState };\n      this.initPageModal(modalState);\n      const currentModalState = { ...modalState };\n\n      let needAnimate = false;\n\n      if (prevModalState.expandable === currentModalState.expandable) {\n        if (prevModalState.translateYFrom !== currentModalState.translateYFrom) {\n          needAnimate = true;\n        }\n      } else {\n        needAnimate = true;\n      }\n\n      if (needAnimate) {\n        this.animateTranslate(modalState, modalState.translateY);\n      }\n    }\n  }\n\n  updateModalHeight = () => {\n    const { activeModal, nextModal } = this.state;\n\n    const modalId = activeModal || nextModal;\n    const modalState = modalId ? this.modalsState[modalId] : undefined;\n\n    if (modalState && modalState.type === ModalType.PAGE && modalState.dynamicContentHeight) {\n      if (this.state.switching) {\n        this.waitTransitionFinish(modalState, () => {\n          requestAnimationFrame(() => this.checkPageContentHeight());\n        });\n      } else {\n        requestAnimationFrame(() => this.checkPageContentHeight());\n      }\n    }\n  };\n\n  closeActiveModal() {\n    // Сбрасываем состояния, которые могут помешать закрытию модального окна\n    this.setState({ touchDown: false, switching: false });\n\n    if (this.props.platform === IOS) {\n      this.window.removeEventListener('resize', this.updateModalTranslate, false);\n    }\n\n    const { prevModal } = this.state;\n    if (!prevModal) {\n      return warn(`[closeActiveModal] prevModal is ${prevModal}`);\n    }\n\n    const prevModalState = this.modalsState[prevModal];\n\n    this.waitTransitionFinish(prevModalState, this.prevNextSwitchEndHandler);\n    this.animateTranslate(prevModalState, 100);\n    this.setMaskOpacity(prevModalState, 0);\n  }\n\n  onTouchMove = (e: TouchEvent) => {\n    if (this.state.switching) {\n      return;\n    }\n    const activeModal = this.state.activeModal || this.state.nextModal;\n    if (!activeModal) {\n      return;\n    }\n\n    const modalState = this.modalsState[activeModal];\n\n    if (modalState.type === ModalType.PAGE) {\n      return this.onPageTouchMove(e, modalState);\n    }\n\n    if (modalState.type === ModalType.CARD) {\n      return this.onCardTouchMove(e, modalState);\n    }\n  };\n\n  onPageTouchMove(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { shiftY, startT, originalEvent } = event;\n    const target = originalEvent.target as HTMLElement;\n\n    if (!event.isY) {\n      if (this.viewportRef.current.contains(target)) {\n        originalEvent.preventDefault();\n      }\n      return;\n    }\n\n    if (!modalState.innerElement.contains(target)) {\n      return originalEvent.preventDefault();\n    }\n\n    originalEvent.stopPropagation();\n\n    const { expandable, contentScrolled, collapsed, expanded } = modalState;\n\n    if (!this.state.touchDown) {\n      modalState.touchStartTime = startT;\n      modalState.touchStartContentScrollTop = modalState.contentElement.scrollTop;\n      this.setState({ touchDown: true });\n    }\n\n    if (contentScrolled) {\n      return;\n    }\n\n    if (modalState.touchMovePositive === null) {\n      modalState.touchMovePositive = shiftY > 0;\n    }\n\n    if (\n      !modalState.expandable ||\n      collapsed ||\n      expanded && modalState.touchMovePositive && modalState.touchStartContentScrollTop === 0 ||\n      modalState.headerElement.contains(target)\n    ) {\n      originalEvent.preventDefault();\n\n      if (!expandable && shiftY < 0) {\n        return;\n      }\n\n      !this.state.dragging && this.setState({ dragging: true });\n\n      const shiftYPercent = shiftY / this.window.innerHeight * 100;\n      const shiftYCurrent = rubber(shiftYPercent, 72, 0.8, this.props.platform === ANDROID || this.props.platform === VKCOM);\n\n      modalState.touchShiftYPercent = shiftYPercent;\n      modalState.translateYCurrent = rangeTranslate(modalState.translateY + shiftYCurrent);\n\n      this.animateTranslate(modalState, modalState.translateYCurrent);\n      this.setMaskOpacity(modalState);\n    }\n  }\n\n  onCardTouchMove(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { originalEvent, shiftY, startT } = event;\n    const target = originalEvent.target as HTMLElement;\n    if (modalState.innerElement.contains(target)) {\n      if (!this.state.touchDown) {\n        modalState.touchStartTime = startT;\n        this.setState({ touchDown: true, dragging: true });\n      }\n\n      const shiftYPercent = shiftY / modalState.innerElement.offsetHeight * 100;\n      const shiftYCurrent = rubber(shiftYPercent, 72, 1.2, this.props.platform === ANDROID || this.props.platform === VKCOM);\n\n      modalState.touchShiftYPercent = shiftYPercent;\n      modalState.translateYCurrent = Math.max(0, modalState.translateY + shiftYCurrent);\n\n      this.animateTranslate(modalState, modalState.translateYCurrent);\n      this.setMaskOpacity(modalState);\n    }\n  }\n\n  onTouchEnd = (e: TouchEvent) => {\n    const activeModal = this.state.activeModal || this.state.nextModal;\n    if (!activeModal) {\n      return;\n    }\n    const modalState = this.modalsState[activeModal];\n\n    if (modalState.type === ModalType.PAGE) {\n      return this.onPageTouchEnd(e, modalState);\n    }\n\n    if (modalState.type === ModalType.CARD) {\n      return this.onCardTouchEnd(modalState);\n    }\n  };\n\n  onPageTouchEnd(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { startY, shiftY } = event;\n\n    modalState.contentScrolled = false;\n    modalState.touchMovePositive = null;\n\n    let setStateCallback;\n\n    if (this.state.dragging) {\n      const shiftYEndPercent = (startY + shiftY) / this.window.innerHeight * 100;\n\n      let translateY = modalState.translateYCurrent;\n      const expectTranslateY = translateY / (Date.now() - modalState.touchStartTime.getTime()) * 240 * 0.6 * (modalState.touchShiftYPercent < 0 ? -1 : 1);\n      translateY = rangeTranslate(translateY + expectTranslateY);\n\n      if (modalState.settlingHeight !== 100) {\n        if (numberInRange(translateY, modalState.expandedRange)) {\n          translateY = modalState.expandedRange[0];\n        } else if (numberInRange(translateY, modalState.collapsedRange)) {\n          translateY = modalState.translateYFrom;\n        } else if (numberInRange(translateY, modalState.hiddenRange)) {\n          translateY = 100;\n        } else {\n          translateY = modalState.translateYFrom;\n        }\n      } else {\n        if (numberInRange(translateY, [0, 25])) {\n          translateY = 0;\n        } else {\n          translateY = 100;\n        }\n      }\n\n      if (translateY !== 100 && shiftYEndPercent >= 75) {\n        translateY = 100;\n      }\n\n      modalState.translateY = translateY;\n      modalState.translateYCurrent = translateY;\n      modalState.collapsed = translateY > 0 && translateY < shiftYEndPercent;\n      modalState.expanded = translateY === 0;\n      modalState.hidden = translateY === 100;\n\n      if (modalState.hidden) {\n        this.doCloseModal(modalState);\n      }\n\n      setStateCallback = () => {\n        if (!modalState.hidden) {\n          this.animateTranslate(modalState, modalState.translateY);\n        }\n\n        this.setMaskOpacity(modalState);\n      };\n    }\n\n    this.setState({\n      touchDown: false,\n      dragging: false,\n    }, setStateCallback);\n  }\n\n  onCardTouchEnd(modalState: ModalsStateEntry) {\n    let setStateCallback;\n\n    if (this.state.dragging) {\n      let translateY = modalState.translateYCurrent;\n\n      const expectTranslateY = translateY / (Date.now() - modalState.touchStartTime.getTime()) * 240 * 0.6 * (modalState.touchShiftYPercent < 0 ? -1 : 1);\n      translateY = Math.max(0, translateY + expectTranslateY);\n\n      if (translateY >= 30) {\n        translateY = 100;\n      } else {\n        translateY = 0;\n      }\n\n      modalState.translateY = translateY;\n      modalState.hidden = translateY === 100;\n\n      if (modalState.hidden) {\n        this.doCloseModal(modalState);\n      }\n\n      setStateCallback = () => {\n        if (!modalState.hidden) {\n          this.animateTranslate(modalState, modalState.translateY);\n        }\n\n        this.setMaskOpacity(modalState);\n      };\n    }\n\n    this.setState({\n      touchDown: false,\n      dragging: false,\n    }, setStateCallback);\n  }\n\n  onScroll = (e: React.SyntheticEvent) => {\n    const activeModal = this.state.activeModal;\n\n    const target = e.target as HTMLElement;\n\n    if (!activeModal) {\n      return;\n    }\n    const modalState = this.modalsState[activeModal];\n    if (modalState.type === ModalType.PAGE && modalState.contentElement.contains(target)) {\n      modalState.contentScrolled = true;\n\n      clearTimeout(modalState.contentScrollStopTimeout);\n\n      modalState.contentScrollStopTimeout = setTimeout(() => {\n        if (modalState.contentScrolled) {\n          modalState.contentScrolled = false;\n        }\n      }, 250);\n    }\n  };\n\n  waitTransitionFinish(modalState: ModalsStateEntry, eventHandler: () => void) {\n    if (transitionEvent.supported) {\n      const onceHandler = () => {\n        modalState.innerElement.removeEventListener(transitionEvent.name, onceHandler);\n        eventHandler();\n      };\n\n      modalState.innerElement.addEventListener(transitionEvent.name, onceHandler);\n    } else {\n      setTimeout(eventHandler, this.props.platform === ANDROID || this.props.platform === VKCOM ? 320 : 400);\n    }\n  }\n\n  switchPrevNext() {\n    const { prevModal, nextModal } = this.state;\n\n    const prevModalState = this.modalsState[prevModal];\n    const nextModalState = this.modalsState[nextModal];\n\n    if (IS_DEV && !prevModalState && !nextModalState) {\n      return warn(`[switchPrevNext] prevModal is ${prevModal}, nextModal is ${nextModal}`);\n    }\n\n    const prevIsPage = !!prevModalState && prevModalState.type === ModalType.PAGE;\n    const prevIsCard = !!prevModalState && prevModalState.type === ModalType.CARD;\n\n    const nextIsPage = !!nextModalState && nextModalState.type === ModalType.PAGE;\n    const nextIsCard = !!nextModalState && nextModalState.type === ModalType.CARD;\n\n    // Ждём полного скрытия предыдущей модалки\n    if (prevModalState && (nextIsCard || prevIsCard && nextIsPage)) {\n      this.waitTransitionFinish(prevModalState, () => {\n        this.activeTransitions += 1;\n        this.waitTransitionFinish(nextModalState, this.prevNextSwitchEndHandler);\n        this.animateTranslate(nextModalState, nextModalState.translateY);\n      });\n\n      return this.animateTranslate(prevModalState, 100);\n    }\n\n    if (prevModalState && nextIsPage) {\n      this.activeTransitions += 1;\n      this.waitTransitionFinish(prevModalState, this.prevNextSwitchEndHandler);\n\n      if (prevIsPage && prevModalState.translateY <= nextModalState.translateYFrom && !this.state.isBack) {\n        this.animateTranslate(prevModalState, nextModalState.translateYFrom + 10);\n      } else {\n        this.animateTranslate(prevModalState, 100);\n      }\n    }\n\n    this.activeTransitions += 1;\n    this.waitTransitionFinish(nextModalState, this.prevNextSwitchEndHandler);\n    this.animateTranslate(nextModalState, nextModalState.translateY);\n  }\n\n  prevNextSwitchEndHandler = () => {\n    this.activeTransitions = Math.max(0, this.activeTransitions - 1);\n    if (this.activeTransitions > 0) {\n      return;\n    }\n\n    const activeModal = this.state.nextModal;\n\n    const newState: ModalRootState = {\n      prevModal: null,\n      nextModal: null,\n      visibleModals: [activeModal],\n      activeModal: activeModal,\n      animated: false,\n      switching: false,\n    };\n\n    if (!activeModal) {\n      newState.history = [];\n    }\n\n    this.setState(newState);\n  };\n\n  /**\n   * Анимирует сдвиг модалки\n   *\n   * @param {ModalsStateEntry} modalState\n   * @param {number} percent Процент сдвига: 0 – полностью открыта, 100 – полностью закрыта\n   */\n  animateTranslate(modalState: ModalsStateEntry, percent: number) {\n    const frameId = `animateTranslateFrame${modalState.id}`;\n\n    cancelAnimationFrame(this.frameIds[frameId]);\n\n    this.frameIds[frameId] = requestAnimationFrame(() => {\n      setTransformStyle(modalState.innerElement, `translate3d(0, ${percent}%, 0)`);\n\n      if (modalState.type === ModalType.PAGE && modalState.footerElement) {\n        const footerHeight = modalState.footerElement.offsetHeight;\n        const factor = modalState.innerElement.offsetHeight * (percent / 100);\n\n        setTransformStyle(modalState.footerElement, `translateY(calc(${footerHeight}px * -${factor / footerHeight}))`);\n      }\n    });\n  }\n\n  /* Устанавливает прозрачность для полупрозрачной подложки */\n  setMaskOpacity(modalState: ModalsStateEntry, forceOpacity: number = null) {\n    if (forceOpacity === null && this.state.history[0] !== modalState.id) {\n      return;\n    }\n\n    cancelAnimationFrame(this.maskAnimationFrame);\n    this.maskAnimationFrame = requestAnimationFrame(() => {\n      if (this.maskElementRef.current) {\n        const { translateY, translateYCurrent } = modalState;\n\n        const opacity = forceOpacity === null ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0 : forceOpacity;\n        this.maskElementRef.current.style.opacity = Math.max(0, Math.min(100, opacity)).toString();\n      }\n    });\n  }\n\n  /**\n   * Закрывает текущую модалку\n   */\n  triggerActiveModalClose = () => {\n    const activeModalState = this.modalsState[this.state.activeModal];\n    if (activeModalState) {\n      this.doCloseModal(activeModalState);\n    }\n  };\n\n  private readonly doCloseModal = (modalState: ModalsStateEntry) => {\n    // Сбрасываем состояния, которые могут помешать закрытию модального окна\n    this.setState({ touchDown: false, switching: false });\n\n    if (isFunction(modalState.onClose)) {\n      modalState.onClose();\n    } else if (isFunction(this.props.onClose)) {\n      this.props.onClose(modalState.id);\n    } else if (IS_DEV) {\n      warn('onClose is undefined');\n    }\n  };\n\n  render() {\n    const { prevModal, activeModal, nextModal, visibleModals, animated, touchDown, dragging, switching } = this.state;\n\n    if (!activeModal && !prevModal && !nextModal && !animated) {\n      return null;\n    }\n\n    return (\n      <TouchRootContext.Provider value={true}>\n        <ModalRootContext.Provider value={this.modalRootContext}>\n          <Touch\n            vkuiClass={classNames(getClassName('ModalRoot', this.props.platform), {\n              'ModalRoot--vkapps': this.props.configProvider.webviewType === WebviewType.VKAPPS,\n              'ModalRoot--touched': touchDown,\n              'ModalRoot--switching': switching,\n            })}\n            onMove={this.onTouchMove}\n            onEnd={this.onTouchEnd}\n            onScroll={this.onScroll}\n          >\n            <div\n              vkuiClass=\"ModalRoot__mask\"\n              onClick={this.triggerActiveModalClose}\n              ref={this.maskElementRef}\n            />\n            <div vkuiClass=\"ModalRoot__viewport\" ref={this.viewportRef}>\n              {this.getModals().map((Modal) => {\n                const modalId = getNavId(Modal.props, warn);\n                if (!visibleModals.includes(modalId)) {\n                  return null;\n                }\n                const modalState = { ...this.modalsState[modalId] };\n\n                const isPage = modalState.type === ModalType.PAGE;\n                const key = `modal-${modalId}`;\n\n                return (\n                  <div\n                    key={key}\n                    ref={(e) => this.modalsState[modalId].modalElement = e}\n                    vkuiClass={classNames('ModalRoot__modal', {\n                      'ModalRoot__modal--active': modalId === activeModal,\n                      'ModalRoot__modal--prev': modalId === prevModal,\n                      'ModalRoot__modal--next': modalId === nextModal,\n\n                      'ModalRoot__modal--dragging': dragging,\n\n                      'ModalRoot__modal--expandable': isPage && modalState.expandable,\n                      'ModalRoot__modal--expanded': isPage && modalState.expanded,\n                      'ModalRoot__modal--collapsed': isPage && modalState.collapsed,\n                    })}\n                  >{Modal}</div>\n                );\n              })}\n            </div>\n          </Touch>\n        </ModalRootContext.Provider>\n      </TouchRootContext.Provider>\n    );\n  }\n}\n\nexport const ModalRootTouch = withContext(withPlatform(withDOM<ModalRootProps>(ModalRootTouchComponent)), ConfigProviderContext, 'configProvider');\n"],"file":"ModalRoot.js"}